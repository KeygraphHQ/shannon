// Shannon SaaS Database Schema
// Combined: Onboarding & Setup + Security Scans Feature

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User synced from Clerk
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // Clerk user ID
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships  OrganizationMembership[]
  auditLogs    AuditLog[]
  invitations  Invitation[]
  findingNotes FindingNote[]

  @@index([createdAt])
}

// Organization (tenant/workspace)
model Organization {
  id                  String    @id @default(cuid())
  name                String
  slug                String    @unique
  plan                String    @default("free") // free, pro, enterprise
  logoUrl             String?
  require2FA          Boolean   @default(false) // Enterprise feature: enforce 2FA for all members
  deletedAt           DateTime? // Soft delete: set to current time when deleted, purged after 30 days
  scheduledDeletionAt DateTime? // When the org will be permanently deleted
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  memberships OrganizationMembership[]
  auditLogs   AuditLog[]
  projects    Project[]
  scans       Scan[]
  invitations Invitation[]

  // Reporting & Compliance relations
  reports         Report[]
  reportTemplates ReportTemplate[]
  reportSchedules ReportSchedule[]

  @@index([deletedAt])
  @@index([plan])
  @@index([createdAt])
}

// Organization membership with role
model OrganizationMembership {
  id             String    @id @default(cuid())
  userId         String
  organizationId String
  role           String    @default("owner") // owner, admin, member, viewer
  createdAt      DateTime  @default(now())
  lastActiveAt   DateTime?

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
}

// Audit log for security events
model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?
  action         String // user.created, org.created, member.invited, etc.
  resourceType   String? // user, organization, scan, etc.
  resourceId     String?
  metadata       Json?
  ipAddress      String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([createdAt])
  @@index([action])
  @@index([organizationId, createdAt])
  @@index([organizationId, action])
}

// Team invitation
model Invitation {
  id             String    @id @default(cuid())
  token          String    @unique @default(cuid())
  email          String
  organizationId String
  role           String    @default("member") // owner, admin, member, viewer
  invitedById    String
  status         String    @default("pending") // pending, accepted, expired, revoked
  expiresAt      DateTime
  createdAt      DateTime  @default(now())
  acceptedAt     DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@index([status])
  @@index([organizationId, status])
}

// ===================
// Security Scans Feature
// ===================

// Project - target application configured for security testing
model Project {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  targetUrl      String // Base URL for scanning
  repositoryUrl  String? // Optional: linked source code repo
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scans                Scan[]
  authenticationConfig AuthenticationConfig?

  // Reporting & Compliance relations
  reportSchedules ReportSchedule[]

  @@index([organizationId])
}

// Scan status enum
enum ScanStatus {
  PENDING // Queued, waiting for slot
  RUNNING // Actively scanning
  COMPLETED // Finished successfully
  FAILED // Finished with error
  CANCELLED // User cancelled
  TIMEOUT // Exceeded max duration
}

// Scan source enum
enum ScanSource {
  MANUAL // User-triggered via UI
  SCHEDULED // Triggered by schedule
  CICD // Triggered by CI/CD integration (PR)
  API // Triggered via API
}

// Scan - single security test execution
model Scan {
  id                 String     @id @default(cuid())
  organizationId     String // Denormalized for query efficiency
  projectId          String
  status             ScanStatus @default(PENDING)
  source             ScanSource @default(MANUAL)
  temporalWorkflowId String? // Temporal workflow ID for tracking

  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  durationMs  Int?

  // Progress tracking (cached from Temporal)
  currentPhase    String?
  currentAgent    String?
  progressPercent Int     @default(0)

  // Results summary (denormalized for list views)
  findingsCount Int @default(0)
  criticalCount Int @default(0)
  highCount     Int @default(0)
  mediumCount   Int @default(0)
  lowCount      Int @default(0)

  // Error handling
  errorMessage String?
  errorCode    String?

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  result       ScanResult?
  findings     Finding[]

  // Reporting & Compliance relations
  reports Report[]

  @@index([organizationId])
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([temporalWorkflowId])
  @@index([organizationId, createdAt])
  @@index([organizationId, status])
}

// ScanResult - detailed results from completed scan
model ScanResult {
  id     String @id @default(cuid())
  scanId String @unique

  // Report storage paths (tenant-prefixed)
  reportHtmlPath String? // tenant-{orgId}/scans/{scanId}/report.html
  reportPdfPath  String? // tenant-{orgId}/scans/{scanId}/report.pdf
  reportMdPath   String? // tenant-{orgId}/scans/{scanId}/report.md
  rawOutputPath  String? // tenant-{orgId}/scans/{scanId}/deliverables/

  // Metrics (from Temporal workflow)
  totalTokensUsed Int?
  totalCostUsd    Decimal? @db.Decimal(10, 4)
  agentMetrics    Json? // Per-agent token counts, durations

  // Executive summary (cached for quick access)
  executiveSummary String? @db.Text
  riskScore        Int? // 0-100

  createdAt DateTime @default(now())

  scan Scan @relation(fields: [scanId], references: [id], onDelete: Cascade)
}

// Security finding (vulnerability)
model Finding {
  id          String   @id @default(cuid())
  scanId      String
  title       String
  description String
  severity    String // critical, high, medium, low, info
  category    String // injection, xss, auth, authz, ssrf, etc.
  status      String   @default("open") // open, fixed, accepted_risk, false_positive
  cvss        Float?
  cwe         String?
  remediation String?
  evidence    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  scan  Scan          @relation(fields: [scanId], references: [id], onDelete: Cascade)
  notes FindingNote[]

  // Reporting & Compliance relations
  complianceMappings ComplianceMapping[]

  @@index([scanId])
  @@index([severity])
  @@index([status])
  @@index([category])
  @@index([scanId, severity])
  @@index([scanId, status])
  @@index([status, severity]) // Cross-scan dashboard queries
}

// Finding note (user comment on a finding)
model FindingNote {
  id        String   @id @default(cuid())
  findingId String
  userId    String? // Nullable for onDelete: SetNull
  content   String   @db.VarChar(10000)
  createdAt DateTime @default(now())

  finding Finding @relation(fields: [findingId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([findingId])
  @@index([findingId, createdAt])
}

// Authentication method enum
enum AuthMethod {
  NONE // No authentication required
  FORM // Form-based login
  API_TOKEN // Bearer token / API key
  BASIC // HTTP Basic Auth
  SSO // SSO redirect (limited support)
}

// AuthenticationConfig - encrypted credentials for a project
model AuthenticationConfig {
  id        String     @id @default(cuid())
  projectId String     @unique
  method    AuthMethod

  // Encrypted credentials (AES-256-GCM with org-derived key)
  encryptedCredentials String // JSON encrypted: { username, password, token, etc. }

  // Non-sensitive config (form-based auth)
  loginUrl         String? // Login page URL
  usernameSelector String? // CSS selector for username field
  passwordSelector String? // CSS selector for password field
  submitSelector   String? // CSS selector for submit button
  successIndicator String? // CSS selector to verify successful login

  // TOTP support
  totpEnabled  Boolean @default(false)
  totpSelector String? // CSS selector for TOTP field

  // Validation state
  lastValidatedAt  DateTime?
  validationStatus String? // valid, invalid, untested

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

// ===================
// Reporting & Compliance Feature
// ===================

// Report status enum
enum ReportStatus {
  GENERATING // In progress
  COMPLETED  // Successfully generated
  FAILED     // Generation failed
}

// Report type enum
enum ReportType {
  EXECUTIVE  // Executive Summary template
  TECHNICAL  // Technical Detail template
  COMPLIANCE // Compliance-Focused template
  CUSTOM     // Custom template
}

// Schedule frequency enum
enum ScheduleFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM // Uses cronExpression
}

// Schedule status enum
enum ScheduleStatus {
  ACTIVE
  PAUSED
  FAILED // Last run failed
}

// Report - Generated security report (immutable after creation)
model Report {
  id             String       @id @default(cuid())
  organizationId String       // Denormalized for query efficiency
  scanId         String
  templateId     String?      // Null for built-in templates
  type           ReportType
  status         ReportStatus @default(GENERATING)

  // Report metadata (immutable snapshot)
  title         String
  generatedAt   DateTime?
  generatedById String // User who triggered generation

  // Findings snapshot at generation time
  findingsCount Int @default(0)
  criticalCount Int @default(0)
  highCount     Int @default(0)
  mediumCount   Int @default(0)
  lowCount      Int @default(0)
  riskScore     Int? // 0-100

  // Compliance frameworks included (JSON array of framework IDs)
  frameworkIds String[] @default([])

  // Storage paths (tenant-prefixed)
  storagePath String? // tenant-{orgId}/reports/{reportId}/
  pdfPath     String? // .../report.pdf
  htmlPath    String? // .../report.html
  jsonPath    String? // .../report.json

  // Template snapshot (JSON blob of template config at generation time)
  templateSnapshot Json?

  // Error handling
  errorMessage String?

  // Soft delete (admin only, with audit log)
  deletedAt   DateTime?
  deletedById String?

  createdAt DateTime @default(now())

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scan         Scan             @relation(fields: [scanId], references: [id], onDelete: Cascade)
  template     ReportTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  shares       ReportShare[]
  accessLogs   ReportAccessLog[]

  @@index([organizationId])
  @@index([scanId])
  @@index([status])
  @@index([createdAt])
  @@index([organizationId, createdAt])
  @@index([deletedAt])
}

// ReportTemplate - Custom report template with organization branding
model ReportTemplate {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  description    String?

  // Branding
  logoUrl        String?
  primaryColor   String? // Hex color
  secondaryColor String? // Hex color

  // Section configuration (JSON array of section IDs in order)
  // e.g., ["executive_summary", "risk_score", "findings", "compliance", "remediation"]
  sections String[] @default([])

  // Custom content blocks (JSON)
  // { "header_text": "...", "footer_text": "...", "disclaimer": "..." }
  customContent Json?

  // Org default flag
  isDefault Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reports      Report[]
  schedules    ReportSchedule[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isDefault])
}

// ReportShare - Secure sharing of reports via token-based links
model ReportShare {
  id        String @id @default(cuid())
  reportId  String
  tokenHash String @unique // SHA-256 hash (token itself not stored)

  // Recipient info
  recipientEmail String? // Who it was shared with
  recipientName  String?
  message        String? // Optional message from sender

  // Access control
  expiresAt   DateTime // Default: 7 days from creation
  maxAccesses Int?     // Optional limit (null = unlimited)
  accessCount Int      @default(0)

  // Revocation
  revokedAt   DateTime?
  revokedById String?

  // Watermark info (embedded in shared report)
  watermarkText String? // e.g., "Shared with john@example.com"

  createdAt   DateTime @default(now())
  createdById String

  // Relations
  report     Report            @relation(fields: [reportId], references: [id], onDelete: Cascade)
  accessLogs ReportAccessLog[]

  @@index([reportId])
  @@index([expiresAt])
  @@index([tokenHash])
}

// ReportAccessLog - Audit trail for report access
model ReportAccessLog {
  id       String  @id @default(cuid())
  reportId String
  shareId  String? // Null if direct access by org member

  // Access details
  accessedAt      DateTime @default(now())
  accessedById    String?  // User ID if authenticated
  accessedByEmail String?  // Email if via share link
  ipAddress       String?
  userAgent       String?

  // Access type
  accessType String // 'view', 'download_pdf', 'download_html', 'download_json', 'download_csv'

  // Relations
  report Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  share  ReportShare? @relation(fields: [shareId], references: [id], onDelete: SetNull)

  @@index([reportId])
  @@index([shareId])
  @@index([accessedAt])
  @@index([reportId, accessedAt])
}

// ReportSchedule - Automated report generation schedule
model ReportSchedule {
  id             String @id @default(cuid())
  organizationId String
  projectId      String

  // Schedule configuration
  name           String
  frequency      ScheduleFrequency
  cronExpression String? // For CUSTOM frequency
  timezone       String  @default("UTC")

  // Report configuration
  templateId   String? // Null for default template
  reportType   ReportType @default(EXECUTIVE)
  frameworkIds String[]   @default([])

  // Recipients (JSON array of email addresses)
  recipients String[]

  // Behavior when no new scans
  skipIfNoNewScans Boolean @default(true)

  // Status and tracking
  status             ScheduleStatus @default(ACTIVE)
  temporalScheduleId String?        // Temporal schedule handle

  // Last run info
  lastRunAt       DateTime?
  lastRunStatus   String? // 'completed', 'skipped', 'failed'
  lastRunReportId String?
  lastRunError    String?
  nextRunAt       DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  template     ReportTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  runs         ScheduleRun[]

  @@index([organizationId])
  @@index([projectId])
  @@index([status])
  @@index([nextRunAt])
}

// ScheduleRun - Record of a scheduled report generation run
model ScheduleRun {
  id         String @id @default(cuid())
  scheduleId String

  // Run details
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  status      String // 'running', 'completed', 'skipped', 'failed'

  // Results
  reportId     String? // Null if skipped or failed
  skipReason   String? // 'no_new_scans', etc.
  errorMessage String?

  // Relations
  schedule ReportSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([startedAt])
}

// ComplianceMapping - Maps findings to compliance framework controls
model ComplianceMapping {
  id        String @id @default(cuid())
  findingId String

  // Framework reference
  frameworkId      String // 'owasp-top-10-2021', 'pci-dss-4.0', etc.
  frameworkVersion String // '2021', '4.0', etc.
  controlId        String // 'A01', 'Req-6.2', etc.
  controlName      String // Denormalized for display

  // Mapping confidence
  confidence String @default("auto") // 'auto', 'manual', 'verified'

  createdAt DateTime @default(now())

  // Relations
  finding Finding @relation(fields: [findingId], references: [id], onDelete: Cascade)

  @@unique([findingId, frameworkId, controlId])
  @@index([findingId])
  @@index([frameworkId])
  @@index([controlId])
  @@index([frameworkId, controlId])
}
