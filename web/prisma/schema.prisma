// Shannon SaaS Database Schema
// Onboarding & Setup - MVP Slice

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User synced from Clerk
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // Clerk user ID
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships OrganizationMembership[]
  auditLogs   AuditLog[]
}

// Organization (tenant/workspace)
model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, pro, enterprise
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships OrganizationMembership[]
  auditLogs   AuditLog[]
  projects    Project[]
  scans       Scan[]
}

// Organization membership with role
model OrganizationMembership {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           String   @default("owner") // owner, admin, member, viewer
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

// Audit log for security events
model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?
  action         String // user.created, org.created, member.invited, etc.
  resourceType   String? // user, organization, scan, etc.
  resourceId     String?
  metadata       Json?
  ipAddress      String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([createdAt])
}

// ===================
// Security Scans Feature
// ===================

// Project - target application configured for security testing
model Project {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  targetUrl      String // Base URL for scanning
  repositoryUrl  String? // Optional: linked source code repo
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scans                Scan[]
  authenticationConfig AuthenticationConfig?

  @@index([organizationId])
}

// Scan status enum
enum ScanStatus {
  PENDING // Queued, waiting for slot
  RUNNING // Actively scanning
  COMPLETED // Finished successfully
  FAILED // Finished with error
  CANCELLED // User cancelled
  TIMEOUT // Exceeded max duration
}

// Scan source enum
enum ScanSource {
  MANUAL // User-triggered via UI
  SCHEDULED // Triggered by schedule
  CICD // Triggered by CI/CD integration (PR)
  API // Triggered via API
}

// Scan - single security test execution
model Scan {
  id                 String     @id @default(cuid())
  organizationId     String // Denormalized for query efficiency
  projectId          String
  status             ScanStatus @default(PENDING)
  source             ScanSource @default(MANUAL)
  temporalWorkflowId String? // Temporal workflow ID for tracking

  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  durationMs  Int?

  // Progress tracking (cached from Temporal)
  currentPhase    String?
  currentAgent    String?
  progressPercent Int     @default(0)

  // Results summary (denormalized for list views)
  findingsCount Int @default(0)
  criticalCount Int @default(0)
  highCount     Int @default(0)
  mediumCount   Int @default(0)
  lowCount      Int @default(0)

  // Error handling
  errorMessage String?
  errorCode    String?

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  result       ScanResult?

  @@index([organizationId])
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([temporalWorkflowId])
}

// ScanResult - detailed results from completed scan
model ScanResult {
  id     String @id @default(cuid())
  scanId String @unique

  // Report storage paths (tenant-prefixed)
  reportHtmlPath String? // tenant-{orgId}/scans/{scanId}/report.html
  reportPdfPath  String? // tenant-{orgId}/scans/{scanId}/report.pdf
  reportMdPath   String? // tenant-{orgId}/scans/{scanId}/report.md
  rawOutputPath  String? // tenant-{orgId}/scans/{scanId}/deliverables/

  // Metrics (from Temporal workflow)
  totalTokensUsed Int?
  totalCostUsd    Decimal? @db.Decimal(10, 4)
  agentMetrics    Json? // Per-agent token counts, durations

  // Executive summary (cached for quick access)
  executiveSummary String? @db.Text
  riskScore        Int? // 0-100

  createdAt DateTime @default(now())

  scan Scan @relation(fields: [scanId], references: [id], onDelete: Cascade)
}

// Authentication method enum
enum AuthMethod {
  NONE // No authentication required
  FORM // Form-based login
  API_TOKEN // Bearer token / API key
  BASIC // HTTP Basic Auth
  SSO // SSO redirect (limited support)
}

// AuthenticationConfig - encrypted credentials for a project
model AuthenticationConfig {
  id        String     @id @default(cuid())
  projectId String     @unique
  method    AuthMethod

  // Encrypted credentials (AES-256-GCM with org-derived key)
  encryptedCredentials String // JSON encrypted: { username, password, token, etc. }

  // Non-sensitive config (form-based auth)
  loginUrl         String? // Login page URL
  usernameSelector String? // CSS selector for username field
  passwordSelector String? // CSS selector for password field
  submitSelector   String? // CSS selector for submit button
  successIndicator String? // CSS selector to verify successful login

  // TOTP support
  totpEnabled  Boolean @default(false)
  totpSelector String? // CSS selector for TOTP field

  // Validation state
  lastValidatedAt  DateTime?
  validationStatus String? // valid, invalid, untested

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}
